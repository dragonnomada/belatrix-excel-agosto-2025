# Excel con Dashboards

![logo](https://www.belatrix.com/wp-content/uploads/2023/08/belatrix-logosweb-1.png)

> Alan Badillo Salas (alan@belatrix.com)

```markdown
Módulo III – Automatización con Macros y VBA

1. Introducción a las macros y VBA
2. Acceso y modificación de celdas en VBA
3. Vectores y matrices
4. Funciones personalizadas (UDF)
5. Controles del programador
```

## M301. Introducción a las macros y VBA

* **Macros** → Son grabaciones de acciones que realizas en Excel y que luego se pueden reproducir para automatizar tareas repetitivas.
* **VBA (Visual Basic for Applications)** → Es el lenguaje de programación que está detrás de las macros. Con VBA se pueden hacer cosas más avanzadas que con la grabadora.

### Primer paso

1. Ve a **Archivo** → **Opciones** → **Personalizar cinta de opciones**.
2. Activa la pestaña **Programador**.
3. En esa pestaña se puede:
   * Grabar macro (automático).
   * Abrir el Editor de VBA (manual, para escribir código).

### Ejemplo: Grabar una macro

* Ve a **Programador** → Grabar macro, escribe un nombre (sin espacios, ej. `FormatoTabla`).
* Haz algo: cambia color de celda, ajusta ancho de columnas.
* Pulsa Detener grabación.
* Luego **Ejecutar macro** y verás que repite las acciones.

## M302. Acceso y modificación de celdas en VBA

> Modificar el valor de una celda

```vba
Sub ModificarCelda()
    ' Modificar una celda específica
    Range("A1").Value = "Hola mundo"
    
    ' Otra forma: usando filas y columnas
    Cells(2, 1).Value = 123
    
    ' Cambiar formato
    Range("A1").Font.Bold = True ' Poner en negritas
    Range("A1").Interior.Color = RGB(255, 255, 0) ' Amarillo
End Sub
```

> Recuperar el valor de una celda, agregar 1 y modificar la celda

```vba
Sub ModificarCelda2()
    Dim valor as Integer
    
    valor = Range("A1").Value

    valor = valor + 1

    Range("A1").Value = valor
End Sub
```

### Variables y Tipos de Datos

#### 1. ¿Qué es una variable?

Es un espacio en memoria donde guardas temporalmente un valor (número, texto, fecha, etc.) mientras tu macro se ejecuta. 

* **Nota:** Si no defines variables, VBA las crea automáticamente como tipo Variant, pero eso es más lento y menos seguro.

#### 2. Cómo definir variables

```vba
Dim <nombreVariable> As <TipoDeDato>
```

* `Dim` → significa dimensionar, es decir, reservar espacio.
* `nombreVariable` → debe comenzar con letra, sin espacios (se puede usar guion bajo _).
* `TipoDeDato` → indica qué tipo de información va a almacenar.

> Ejemplos:

```vba
Dim contador As Integer
Dim nombre As String
Dim fechaNacimiento As Date
Dim precio As Double
Dim activo As Boolean
```

#### 3. Tipos de datos más comunes en VBA

Tipo de dato | Almacena | Ejemplo
--- | --- | ---
**Integer** | Enteros de -32,768 a 32,767 | Dim edad As Integer
**Long** | Enteros más grandes (-2,147,483,648 a 2,147,483,647) | Dim habitantes As Long
**Single** | Números con decimales (precisión simple) | Dim temperatura As Single
**Double** | Números con decimales (alta precisión) | Dim precio As Double
**Currency** | Números monetarios (4 decimales) | Dim sueldo As Currency
**String** | Texto | Dim nombre As String
**Boolean** | Verdadero o Falso | Dim aprobado As Boolean
**Date** | Fechas y horas | Dim hoy As Date
**Variant** | Cualquier tipo de dato (más lento, más memoria) | Dim dato As Variant

#### 4. Asignar valores a variables

```vba
Dim edad As Integer
edad = 30

Dim nombre As String
nombre = "Alan"

Dim aprobado As Boolean
aprobado = True

Dim hoy As Date
hoy = Date ' Fecha actual
```

#### 5. Declarar varias variables

```vba
Dim nombre As String, edad As Integer, sueldo As Double
```

* **Nota** Cada `Dim` deberá especificar el nombre de la variable y su tipo, sino asumirá `Variant`. Por ejemplo, `Dim nombre, edad As Integer` asume que `nombre` no tiene tipo y lo considera `Variant`.

#### 6. Otras palabras clave para variables

* **Static** → mantiene el valor aunque termine la macro.
* **Const** → crea una constante que no se puede cambiar.
* **Public** → variable accesible desde todos los módulos.
* **Private** → variable solo accesible desde el módulo actual.

> Ejemplo:

```vba
Const PI As Double = 3.1416
```

#### 7. Conversiones

Tipo de dato | Función de conversión | Ejemplo | Resultado
--- | --- | --- | ---
**Integer** | CInt(valor) | CInt(5.9) | 6 (redondea al entero más cercano)
**Long** | CLng(valor) | CLng(5.9) | 6
**Single** | CSng(valor) | CSng("3.1416") | 3.1416
**Double** | CDbl(valor) | CDbl("2.71828") | 2.71828
**Currency** | CCur(valor) | CCur("1234.56") | 1234.56
**String** | CStr(valor) | CStr(123) | "123"
**Boolean** | CBool(valor) | CBool(1) | True
**Date** | CDate(valor) | CDate("2025-08-13") | 13/08/2025
**Variant** | No necesita conversión (acepta cualquier tipo) | - | -

**Notas:**

* **CInt** y **CLng** redondean, no truncan.
* **CBool** considera 0 como False y cualquier otro valor como True.
* **CDate** interpreta según la configuración regional (en México 13/08/2025 es válido, pero en EEUU esa fecha daría error si está en formato mm/dd/yyyy).
* Para convertir un número a texto con formato, se usa Format(valor, "0.00") en vez de **CStr**.

#### 8. Fechas

> Partes de la fecha

Componente | Función | Ejemplo | Resultado
--- | --- | --- | ---
**Año** | Year(fecha) | Year(#13/08/2025#) | 2025
**Mes** | Month(fecha) | Month(#13/08/2025#) | 8
**Día** | Day(fecha) | Day(#13/08/2025#) | 13

> Partes de la hora

Componente | Función | Ejemplo | Resultado
--- | --- | --- | ---
**Hora** | Hour(fechaHora) | Hour(#13/08/2025 15:45:30#) | 15
**Minuto** | Minute(fechaHora) | Minute(#13/08/2025 15:45:30#) | 45
**Segundo** | Second(fechaHora) | Second(#13/08/2025 15:45:30#) | 30

> Ejemplo:

```vba
Sub PartesDeFecha()
    Dim fechaActual As Date
    fechaActual = Now ' Fecha y hora actual
    
    MsgBox "Año: " & Year(fechaActual) & vbCrLf & _
           "Mes: " & Month(fechaActual) & vbCrLf & _
           "Día: " & Day(fechaActual) & vbCrLf & _
           "Hora: " & Hour(fechaActual) & vbCrLf & _
           "Minuto: " & Minute(fechaActual) & vbCrLf & _
           "Segundo: " & Second(fechaActual)
End Sub
```

**Notas:**

* **Now** → devuelve fecha y hora actuales.
* **Date** → devuelve solo la fecha actual (hora = 00:00:00).
* **Time** → devuelve solo la hora actual (fecha = 00/01/1900).

> Obtener el nombre del mes o el día

```vba
Format(fechaActual, "mmmm") ' Agosto
Format(fechaActual, "dddd") ' Miércoles
```

### Mensajes y captura de datos

> Ejemplo:

```vba
Sub PreguntarEdad()
    Dim edad As Integer
    
    ' Mostrar prompt y guardar lo que el usuario escribe
    edad = CInt(InputBox("¿Cuál es tu edad?", "Pregunta de edad"))
    
    ' Colocar el valor en la celda A1
    Range("A1").Value = edad
End Sub
```

**Notas:**

* **InputBox(prompt, título)**
  * **prompt** → el texto que verá el usuario.
  * **título** (opcional) → texto en la barra del cuadro de diálogo.
* **CInt(...)** → convierte lo que el usuario escribió a entero.
* Si no pones conversión (CInt), se guarda como texto por defecto.

> Ejemplo con validación:

```vba
Sub PreguntarEdadValidar()
    Dim entrada As String
    Dim edad As Integer
    
    entrada = InputBox("¿Cuál es tu edad?", "Pregunta de edad")
    
    If IsNumeric(entrada) Then
        edad = CInt(entrada)
        Range("A1").Value = edad
    Else
        MsgBox "Debes escribir un número válido.", vbExclamation
    End If
End Sub
```

> Cajas de mensajes

Constante | Tipo de icono / botón | Descripción
--- | --- | ---
**vbOKOnly** | Botón OK | Muestra solo el botón OK
**vbOKCancel** | Botón OK y Cancelar | Permite que el usuario confirme o cancele
**vbAbortRetryIgnore** | Botón Abortir, Reintentar, Ignorar | Para operaciones críticas
**vbYesNoCancel** | Botón Sí, No, Cancelar | Para decisiones múltiples
**vbYesNo** | Botón Sí y No | Preguntas simples de sí/no
**vbRetryCancel** | Botón Reintentar y Cancelar | Para intentos de acción fallida
**vbCritical** | Icono crítico (X rojo) | Señala error grave
**vbQuestion** | Icono de pregunta (?) | Indica consulta al usuario
**vbExclamation** | Icono de advertencia (!) amarillo | Señala alerta o aviso
**vbInformation** | Icono de información (i azul) | Muestra información general

> Ejemplo de advertencia:

```vba
MsgBox "Debes ingresar un número válido", vbExclamation, "Advertencia"
```

**Notas:**

* **"Debes ingresar un número válido"** → texto del mensaje
* **vbExclamation** → ícono de advertencia
* **"Advertencia"** → título del cuadro

> Ejemplo de confirmación

```vba
MsgBox "¿Deseas continuar?", vbYesNo + vbQuestion, "Confirmar"
```